<div class="preguntados-wrapper" *ngIf="!finalizado(); else resultadoTpl">
  <!-- SelecciÃ³n de tema -->
  <section *ngIf="!temaSeleccionado(); else quizTpl" class="tema-section">
    <h2 class="titulo">ğŸ¯ Elige un tema</h2>
    <div class="temas-grid">
      <!-- El *ngFor itera sobre el valor del signal 'temas()' -->
      <!-- El (click) llama al mÃ©todo del componente 'seleccionarTema' con el tema 't' -->
      <button *ngFor="let t of temas()" class="tema-card" (click)="seleccionarTema(t)">
        <div class="emoji">
          {{ t === 'deportes' ? 'ğŸ†' : t === 'musica' ? 'ğŸµ' : t === 'entretenimiento' ? 'ğŸ¬' : 'ğŸ“œ' }}
        </div>
        <span>{{ t | titlecase }}</span>
      </button>
    </div>
  </section>

  <!-- Preguntas -->
  <ng-template #quizTpl>
    <section class="pregunta-section" *ngIf="!loading(); else loadingTpl">
      <div class="header">
        <span class="tema-label">Tema: {{ temaSeleccionado() | titlecase }}</span>
        <span class="progreso">Pregunta {{ indice() + 1 }} / {{ preguntas.length }}</span>
      </div>

      <div class="pregunta-card animate-fade">
        <h3>{{ preguntas[indice()].question }}</h3>
        <div class="opciones-grid">
          <button 
            *ngFor="let op of preguntas[indice()].options; let i = index"
            (click)="responder(i)"
            class="opcion-btn"
            [ngClass]="feedbackClaseRespuesta[i]">
            {{ op }}
          </button>
        </div>
      </div>
    </section>
  </ng-template>

  <!-- Loading -->
  <ng-template #loadingTpl>
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando preguntas...</p>
    </div>
  </ng-template>
</div>

<!-- Resultado final -->
<ng-template #resultadoTpl>
  <div class="resultado animate-fade">
    <h2>ğŸ Â¡Juego finalizado!</h2>
    <p>Respuestas correctas: <strong>{{ correctas() }}</strong> / {{ preguntas.length }}</p>
    <div class="barra-progreso">
      <div class="progreso-interno" [style.width.%]="(correctas() / preguntas.length) * 100"></div>
    </div>

    <!-- SecciÃ³n de historial de respuestas -->
    <div class="historial-respuestas">
      <h3>Detalle de tus respuestas:</h3>
      <div *ngFor="let item of historialRespuestas; let i = index" class="historial-item">
        <h4>{{ i + 1 }}. {{ item.question }}</h4>
        <ul class="opciones-historial">
          <li *ngFor="let opcion of item.options; let j = index"
              [ngClass]="{
                'opcion-correcta': j === item.correctIndex,
                'opcion-usuario-incorrecta': j === item.userAnswerIndex && !item.isCorrect,
                'opcion-usuario-correcta': j === item.userAnswerIndex && item.isCorrect
              }">
            {{ opcion }} 
            <span *ngIf="j === item.userAnswerIndex && item.isCorrect" class="feedback-icon">âœ…</span>
            <span *ngIf="j === item.userAnswerIndex && !item.isCorrect" class="feedback-icon">âŒ</span>
          </li>
        </ul>
      </div>
    </div>
    <!-- Fin secciÃ³n historial -->

    <button (click)="reiniciar()" class="btn-reiniciar">Volver al inicio</button>
  </div>
</ng-template>